generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model SystemSetting {
  id           Int      @id
  title        String?
  description  String?
  keywords     String?
  version      String?
  openRegister Boolean  @default(false)
  createDate   DateTime @default(now())
  updateBy     DateTime @default(now())
}

model User {
  id         Int      @id @default(autoincrement())
  username   String
  password   String
  name       String?
  email      String?
  createDate DateTime @default(now())
}

model Book {
  id         Int      @id @default(autoincrement())
  bookId     String   @unique
  bookName   String
  userId     Int
  createDate DateTime @default(now())
  shareKey   String?
  budget     Float?
  description String?
  color      String   @default("#3B82F6")
  flows      Flow[]   @relation("BookFlows")
}

model Flow {
  id             Int       @id @default(autoincrement())
  userId         Int
  bookId         String
  day            String
  flowType       String?
  industryType   String?
  payType        String?
  money          Float?
  name           String?
  description    String?
  invoice        String?
  attribution    String?
  eliminate      Int?      @default(0)
  origin         String?
  accountId      Int?
  transferId     Int?
  // 借贷相关字段
  loanType       String?   // 借贷类型：借入、借出、收款、还款
  counterparty   String?   // 借贷对象
  relatedFlowId  Int?      // 关联的对应流水ID
  relatedAccountId Int?    // 关联的另一个账户ID（用于借贷记录）
  // 新增显示字段：用于统一显示逻辑
  displayFlowType    String?  // 显示用的流水类型：借贷、转账
  displayIndustryType String? // 显示用的支出/收入类型：借款、还款、借入、收款、转账
  book           Book?     @relation("BookFlows", fields: [bookId], references: [bookId])
  account        Account?  @relation("AccountFlows", fields: [accountId], references: [id])
  relatedAccount Account?  @relation("RelatedAccountFlows", fields: [relatedAccountId], references: [id])
  transfer       Transfer? @relation("TransferFlows", fields: [transferId], references: [id])
  relatedFlow    Flow?     @relation("RelatedFlows", fields: [relatedFlowId], references: [id])
  relatedFlows   Flow[]    @relation("RelatedFlows")
}

model Budget {
  id     Int    @id @default(autoincrement())
  bookId String
  userId Int
  month  String @unique
  budget Float?
  used   Float?
}

model FixedFlow {
  id           Int      @id @default(autoincrement())
  bookId       String
  userId       Int
  month        String?
  money        Float?
  name         String?
  description  String?
  flowType     String?
  industryType String?
  payType      String?
  attribution  String?
  accountId    Int?
  account      Account? @relation("AccountFixedFlows", fields: [accountId], references: [id])
}

model TypeRelation {
  id     Int    @id @default(autoincrement())
  userId Int
  bookId String
  source String
  target String
}

model Account {
  id            Int         @id @default(autoincrement())
  userId        Int
  name          String
  type          String
  balance       Float       @default(0)
  currency      String      @default("CNY")
  isHidden      Boolean     @default(false)
  includeInTotal Boolean    @default(true)
  createDate    DateTime    @default(now())
  updateDate    DateTime    @updatedAt
  fixedFlows    FixedFlow[] @relation("AccountFixedFlows")
  flows         Flow[]      @relation("AccountFlows")
  relatedFlows  Flow[]      @relation("RelatedAccountFlows")
  transfersFrom Transfer[]  @relation("TransferFrom")
  transfersTo   Transfer[]  @relation("TransferTo")

  @@unique([userId, name], name: "accounts_userId_name_unique")
  @@map("accounts")
}

model Transfer {
  id            Int      @id @default(autoincrement())
  userId        Int
  fromAccountId Int
  toAccountId   Int
  amount        Float
  day           String
  name          String?
  description   String?
  createDate    DateTime @default(now())
  // 新增字段：统一管理借贷和转账
  transferType  String   @default("transfer") // transfer: 转账, loan: 借贷
  loanType      String?  // 借贷类型：借入、借出、收款、还款
  counterparty  String?   // 借贷对象
  flows         Flow[]   @relation("TransferFlows")
  fromAccount   Account  @relation("TransferFrom", fields: [fromAccountId], references: [id])
  toAccount     Account  @relation("TransferTo", fields: [toAccountId], references: [id])

  @@map("transfers")
}

model Receivable {
  id          Int      @id @default(autoincrement())
  userId      Int
  bookId      String
  occurDay    String
  money       Float
  name        String?
  description String?
  status      Int      @default(0) // 0: 待收款, 1: 已收款
  createDate  DateTime @default(now())
  updateDate  DateTime @updatedAt

  @@map("receivables")
}

/**
 * 流水匹配规则表
 * 用于根据流水特征（交易方、备注、金额、支付方式等）自动匹配账本和分类
 */
model FlowMatchingRule {
  id                Int       @id @default(autoincrement())
  userId            Int       // 规则所属用户
  ruleName          String?   // 规则名称（可选，用于管理）
  
  // 规则类型：MERCHANT_KEYWORD, DESCRIPTION_KEYWORD, AMOUNT_RANGE, PAY_TYPE, COMBINED
  ruleType          String    // 规则类型
  
  // 匹配条件（JSON格式存储，根据ruleType不同而不同）
  // MERCHANT_KEYWORD: { keywords: ["关键词1", "关键词2"] }
  // DESCRIPTION_KEYWORD: { keywords: ["关键词1", "关键词2"] }
  // AMOUNT_RANGE: { min: 0, max: 30 }
  // PAY_TYPE: { payTypes: ["微信", "支付宝"] }
  // COMBINED: { merchantKeywords?: [], descriptionKeywords?: [], amountRange?: {}, payTypes?: [] }
  conditions        String    @db.Text // JSON字符串
  
  // 目标账本和分类
  targetBookId      String    // 目标账本ID
  targetCategory    String?   // 目标分类（industryType）
  targetFlowType    String?   // 目标流水类型（flowType）
  
  // 规则优先级（整数，越大越优先）
  priority          Int       @default(50)
  
  // 规则状态
  enabled           Boolean   @default(true) // 是否启用
  hitCount          Int       @default(0) // 命中次数（用于学习优化）
  
  // 元数据
  createdBy         Int       // 创建者（userId）
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // 规则来源：MANUAL（手动创建）, LEARNED（学习生成）
  source            String    @default("MANUAL") // MANUAL, LEARNED
  
  @@index([userId, enabled])
  @@index([userId, priority])
  @@map("flow_matching_rules")
}

/**
 * 账本画像表
 * 用于存储每个账本的统计信息，支持账本识别
 */
model BookProfile {
  id                Int       @id @default(autoincrement())
  userId            Int       // 用户ID
  bookId            String    // 账本ID
  
  // 分类统计（JSON格式：{ "分类名": 出现次数 }）
  categoryWeights   String    @db.Text // JSON: { "餐饮": 150, "交通": 80, ... }
  
  // 常见交易方关键词（JSON格式：{ "关键词": 出现次数 }，取top N）
  merchantKeywords  String    @db.Text // JSON: { "林家小铺": 45, "星巴克": 30, ... }
  
  // 常见支付方式统计（JSON格式：{ "支付方式": 出现次数 }）
  payTypeStats      String    @db.Text // JSON: { "微信": 200, "支付宝": 150, ... }
  
  // 金额分布区间（JSON格式：{ "区间": 出现次数 }）
  // 区间示例：["0-50", "50-200", "200-500", "500-1000", "1000+"]
  amountDistribution String   @db.Text // JSON: { "0-50": 100, "50-200": 80, ... }
  
  // 统计元数据
  totalFlows        Int       @default(0) // 总流水数（用于计算权重）
  lastUpdatedAt     DateTime  @default(now()) // 最后更新时间
  createdAt         DateTime  @default(now()) // 创建时间
  
  @@unique([userId, bookId])
  @@index([userId])
  @@map("book_profiles")
}
